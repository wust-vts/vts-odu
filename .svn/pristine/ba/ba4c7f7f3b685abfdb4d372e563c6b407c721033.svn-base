using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Text;
using System.Windows.Forms;

namespace YimaEncNavigator
{
    public partial class FormModifyRouteInfo : Form
    {
        public int routeId;
        int geoCoorMultiFactor;
        int[] delWayPointsPos = new int[100];
        int delPointSum = 0;
        int[,] modifyWayPoints = new int[100,2];
        int modifyWayPointSum = 0;
        int wayPointsCount = 0;
        int[] addWayPoints = new int[100];
        int addWayPointSum = 0;

        float[,] oldWayPoints = new float[100, 4];
        int oldWayPointsSum = 0;

        public FormModifyRouteInfo()
        {
            InitializeComponent();
        }

        private void FormmodifyRouteInfo_Load(object sender, EventArgs e)
        {
            this.lb_routeName.Text = "航线名称:Route " + routeId;
            wayPointsCount = ((FormMain)this.Owner).ymEncCtrl.GetWayPointsCount() + 1;
            geoCoorMultiFactor = ((FormMain)this.Owner).ymEncCtrl.GetGeoCoorMultiFactor(); 
            int wayPointCount = ((FormMain)this.Owner).ymEncCtrl.GetRouteWayPointsCount(routeId);
            this.dataGridView1.Rows.Add(wayPointCount);

            string strWayPointIDs = new string('1', 1000);
            ((FormMain)this.Owner).ymEncCtrl.GetRouteWayPointsID(routeId, ref strWayPointIDs);
            int[] wayPointIDs = InteropEncDotNet.GetIntArrayFromString(strWayPointIDs, wayPointCount);

            for (int i = 0; i < wayPointCount; i++)
            {
                int wayPointGeoX = 0;
                int wayPointGeoY = 0;
                ((FormMain)this.Owner).ymEncCtrl.GetWayPointCoor(wayPointIDs[i], ref wayPointGeoX, ref wayPointGeoY);
                this.dataGridView1[1, i].Value = wayPointIDs[i].ToString();
                this.dataGridView1[2, i].Value = ((float)wayPointGeoX / geoCoorMultiFactor).ToString();
                this.dataGridView1[3, i].Value = ((float)wayPointGeoY / geoCoorMultiFactor).ToString();

                oldWayPoints[i, 0] = i;
                oldWayPoints[i, 1] = wayPointIDs[i];
                oldWayPoints[i, 2] = (float)wayPointGeoX / geoCoorMultiFactor;
                oldWayPoints[i, 3] = (float)wayPointGeoY / geoCoorMultiFactor;
                oldWayPointsSum = i +1;
            }
            setRowPost();
        }

        private void setRowPost()
        {
            for (int i = 0; i < dataGridView1.Rows.Count; i++)
            {
                dataGridView1.Rows[i].Cells[0].Value = i+1;
            }
        }

        private void btn_delWayPoint_Click(object sender, EventArgs e)
        {
            int selectItem = this.dataGridView1.CurrentCell.RowIndex;
            delWayPointsPos[delPointSum] = Convert.ToInt32(selectItem);
            delPointSum = delPointSum + 1;
            this.dataGridView1.Rows.RemoveAt(selectItem);
            setRowPost();
        }

        private void btn_addWayPoint_Click(object sender, EventArgs e)
        {            
            this.dataGridView1.Rows.Add(1);
            int selectItem = this.dataGridView1.CurrentCell.RowIndex;
            int itemRowsCount = this.dataGridView1.Rows.Count;
            for (int i = itemRowsCount - 1; i > selectItem; i--)
            {
                this.dataGridView1[0, i].Value = this.dataGridView1[0, i - 1].Value;
                this.dataGridView1[1, i].Value = this.dataGridView1[1, i - 1].Value;
                this.dataGridView1[2, i].Value = this.dataGridView1[2, i - 1].Value;
                this.dataGridView1[3, i].Value = this.dataGridView1[3, i - 1].Value;
            }
            this.dataGridView1[0, selectItem].Value = "";
            this.dataGridView1[1, selectItem].Value = wayPointsCount.ToString();
            this.dataGridView1[2, selectItem].Value = "";
            this.dataGridView1[3, selectItem].Value = "";
            wayPointsCount = wayPointsCount + 1;
            addWayPoints[addWayPointSum] = wayPointsCount;
            addWayPointSum = addWayPointSum + 1;
            setRowPost();
        }

        private void btn_ok_Click(object sender, EventArgs e)
        {
            for (int i = 0; i < delPointSum; i++)
            {
                ((FormMain)this.Owner).ymEncCtrl.DeleteRouteWayPoint(routeId, delWayPointsPos[i], 1);
            }
            int newWayPoint = this.dataGridView1.Rows.Count;
            
            for (int i = 0; i < newWayPoint; i++)
            {
                string curWayPointPos = this.dataGridView1[0,i].Value.ToString();
                string strWpID = this.dataGridView1[1, i].Value.ToString();
                string curWayPointLon = this.dataGridView1[2, i].Value.ToString();
                string curWayPointLat = this.dataGridView1[3, i].Value.ToString();
                bool isModify = false;
                bool isAdd = true;

                for (int j = 0; j < oldWayPointsSum; j++)
                { 
                    string oldWayPointID = ((int)oldWayPoints[j,1]).ToString();
                    string oldWayPointLon = (oldWayPoints[j, 2]).ToString();
                    string oldWayPointLat = (oldWayPoints[j, 3]).ToString();
                    if (strWpID.Equals(oldWayPointID))
                    {
                        isAdd = false;                       

                        if (!curWayPointLon.Equals(oldWayPointLon) || !curWayPointLat.Equals(oldWayPointLat))
                        {
                            isModify = true;
                        }
                        break;
                    }
                }

                if (isAdd)
                {
                    int newWpID = ((FormMain)this.Owner).ymEncCtrl.AddWayPoint((int)(Convert.ToDouble(curWayPointLon) * geoCoorMultiFactor), (int)(Convert.ToDouble(curWayPointLat) * geoCoorMultiFactor), "Wp1");
                    int[] wpIDArr = new int[1];
                    wpIDArr[0] = newWpID;
                    string strNewWpID = InteropEncDotNet.GetStringFromIntArray(wpIDArr, 1);
                    bool addRouteWayPointResult = ((FormMain)this.Owner).ymEncCtrl.AddRouteWayPoint(routeId, Convert.ToInt32(curWayPointPos) - 1, ref strNewWpID, 1);                  
                                     
                }
                else if (isModify)
                {
                    bool setWayPointCoorResult = ((FormMain)this.Owner).ymEncCtrl.SetWayPointCoor(Convert.ToInt32(strWpID), (int)(Convert.ToDouble(curWayPointLon) * geoCoorMultiFactor), (int)(Convert.ToDouble(curWayPointLat) * geoCoorMultiFactor));
                }
            }
            this.Close();
        }
    }
}
